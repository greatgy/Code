$(function($) {
	loadmore();
	
	$(document).on('click', "a[id^='btnprize']", function(){
		unRegisterPraise();
		$(this).prize();
     }); 
	
	$(document).on('click', "a[id^='deletecomment']", function(){
		var obj = $(this).parent().parent();
		if(confirm("确定删除吗？")){
			deleteComment(obj);
		}else{
			return false;
		}
     });
	
	$.fn.scrollHandle({
		obj: window,
		fun: loadmore
	})
	prizeBindEvent(); 
	collectBindEvet();
});

function submitCommentHandler(obj){
	beforeSubmitHandler(obj);
	if(params.content.trim() == ""){
		alert("评论内容不能为空");
		return;
	}
	$.post(base + "/ajax/comment/{0}".format(params.fromuid), params,function(data){
		afterSubmitHandler(data, obj);
		var tempuid = $("#articlecommentcount").html();
		$("#articlecommentcount").html(parseInt(tempuid)+1);
	});
}

var params = {
	content: "",
	fromuid: "",
	cid:""
}

function beforeSubmitHandler(obj){
	params = {};
	params.fromuid = fromuid;
	params.cid = cid;
	var objs = $(obj).parent().siblings(".comment_textarea");
	params.content = objs.val().replace('\n', '<br />');
	var tempobj = $(obj).parent().parent().parent();
	if(!tempobj.hasClass("contentLeft") || !tempobj.hasClass("commentRt")){
		tempobj=$(obj).parent().parent().siblings(".commentRt");
	}
	var touid = tempobj.data("uid");
	var topuid = tempobj.data("topuid");
	if(typeof topuid != "undefined"){
		params.topuid = topuid;
	}
	if(typeof touid != "undefined"){
		params.touid = touid;
		params.touseruid = tempobj.data("touseruid");
		params.tousername = tempobj.data("tousername");
	}
}

function afterSubmitHandler(result, obj){
	if(result.success){
		$(obj).parent().siblings("#content").val("");
		addComment(result.bean, obj);
		$("div").remove("#replyBoxed");
	}else{
		alert("评论失败");
	}
}

function addComment(bean, obj){
	var parentobj = $(obj).parent().parent().parent().parent();
	var html = '';
	if($(parentobj).attr("class").indexOf("iscomment") != -1){
		// 对文章的回复
		html += '<div class="commentitem">';
		html += '<div class="userimg">';
		html += '<img ';
		if (me.imglittle.trim() != "") {
			html += 'src="' + userimg + me.imglittle + '" />';
		} else{
			html += 'src="' + userimg + bean.fromVisitorAvatar  + '">';
		}
		html += '</div>';
		html += '<div class="commentRt replay_comment"  data-uid="' + bean.uid + '" data-touseruid="' + bean.fromuseruid + '"  data-tousername="' + bean.fromusername + '">';
		html += '<div class="name">';
		if (bean.fromusername == null) {
			bean.fromusername = '游客';
		}
		html += '&nbsp;' + bean.fromusername + '&nbsp;';
		html += '<span class="commentTime">&nbsp;刚刚</span>';
		html += '<a id="deletecomment_' + bean.uid + '" class="delete"><img src="' + baseimg + '/imgs/default/crush.png"/></a>';
		html += '</div>';
		html += '<p class="comment">' + bean.content + '</p>';
		html += '<div class="operate">';
		html += '<a data-reply="replyopen" href="javascript:;" class="reply" onclick="reply(this)">回复';
		html += '</a>';
		html += '<a data-reply="true" class="leftcomments hd" onclick="showcomment(this);">&nbsp;|&nbsp;<span id="commentcount">0</span>条回复<img src="' + baseimg + '/imgs/default/arrawDown.png" alt="展开" />';
		html += '</a>';
		html += '<a class="zan" id="btnprize_comments_';
		if (me != "" || me != null || typeof me != 'undefined') {
			html += me.oid;
		} else {
			html += '0';
		}
		html += '_' +cid+'_'+ bean.uid + '" data-counter=".prizecounter">';
		html += '<img src="' + baseimg + '/imgs/default/zan.png" data-isprize="' + false + '"><span class="zancountjs">0</span></a>';
		html += '</div>';
		html += '</div>';
		html += '<div id="second" class="secondComment hd" >';
		html += '</div>';
		html += '<div class="loadmorefinance hd">';
		html += '<a href="javascript:void(0)" id="loadmore" onclick="load(this)">加载更多</a>';
		html += '</div>';
		html += '</div>';
		$("#displayComment").prepend(html);
	} else {
		html += '<li class="ment">';
		html += '<div class="userimg">';
		html += '<img  ';
		if (me.imglittle.trim() != "") {
			html += 'src="' + userimg + me.imglittle + '" />';
		} else{
			html += 'src="' + userimg + bean.fromVisitorAvatar + '">';
		}
		html += '</div>';
		if(typeof params.topuid == "undefined"){
			params.topuid = params.touid;
		}
		html += '<div class="commentRt" data-uid="' + bean.uid + '" data-topuid="' + params.topuid + '" data-touseruid="' + bean.fromuseruid + '"  data-tousername="' + bean.fromusername + '" >';
		html += '<div class="name">';
		html +=  bean.fromusername;
		html += '<span class="commentTime">&nbsp;刚刚</span>';
		html += '<a id="deletecomment_' + bean.uid + '" class="delete"><img src="' + baseimg + '/imgs/default/crush.png"/></a>';
		html += '</div>';
		html += '<p class="comment">';
		html += '<span>@'+bean.tousername+':</span>'+bean.content+'</p>';
		html += '<div class="operate">';
		html += '<a data-reply="replyopen" href="javascript:;" class="reply" onclick="reply(this)">回复</a>';
		html += '<a class="zan" id="btnprize_comments_';
		if (me != "" || me != null || typeof me != 'undefined') {
			html += me.oid;
		} else {
			html += '0';
		}
		html += '_' +cid+'_'+ bean.uid + '" data-counter=".prizecounter">';
		html += '<img src="' + baseimg + '/imgs/default/zan.png" data-isprize="' + false + '"><span class="zancountjs">0</span></a>';
		html += '</div>';
		html += '</div>';
		html += '</li>'
		if($(obj).parent().parent().siblings(".commentRt").attr("class").indexOf("replay_comment") != -1){
			// 对评论的回复
			var secondObj=$(obj).parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments");
			showcomment(secondObj);
			if($(secondObj).parent().parent().siblings("#second").hasClass("hd")){
				showcomment(secondObj);
			}
			// $(obj).parent().siblings("#second").prepend(html);
			if($(obj).parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").hasClass("hd")){
				$(obj).parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").removeClass("hd");
			}
			var temp = $(obj).parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").children("#commentcount").html();
			$(obj).parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").children("#commentcount").html(parseInt(temp)+1);
		}else{
			// 对回复的回复
			$(obj).parent().parent().parent().after(html);
			var temp = $(obj).parent().parent().parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").children("#commentcount").html();
			$(obj).parent().parent().parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").children("#commentcount").html(parseInt(temp)+1);
		}
		$(".comment_textarea1").focus();
		$(obj).parent().parent().siblings("#second").css("display","block");
		initBindEvent();
	}
	initPage();
}

/**
 * 点击评论或者回复,加载评论框
 * 
 * @param obj
 * @returns
 */
function reply(obj){
	var idnumber = getIdNumber();
	if($(obj).data("reply") == "replyopen"){
		if($(".replyBox").length != 0) {
			$(".replyBox").siblings(".wordBottom").children(".commentOperate").children(".reply").data("reply","replyopen");
			$(".replyBox").remove();
		}
		var html = "";
		html += '<div class="replyBox" id="replyBoxed">';
		html += '<textarea class="comment_textarea comment_textarea1" id="' + idnumber + '" data-suffix="' + idnumber + '"/>';
		html += '<div class="wordpiece">';
		html += '<a class="face"><img src="'+baseimg+'/imgs/default/smile.png" alt=""></a>';
		html += '<button type="submit" onclick="submitCommentHandler(this);" class="submitBtn">发表</button>';
		html += '</div>';
		html += '</div>';
		$(obj).parent().parent().after(html);
		$(".replyBox").css("display","block");
		$(".comment_textarea1").focus();
		initBindEvent();
		$(obj).data("reply","replyclose");
		return ;
	}else{
		$(obj).data("reply","replyopen");
		$(".replyBox").remove();
	}
}
var num=1;
var diplayID="#displayComment";
function loadmore(){
	var url = base + "/ajax/comment/finance_"+fromuid+"_{0}".format(num);
	num += 1;
	$.ajax({
		type:"GET",
		url:url,
		success:function(data){
			if(data.trim() == ""){
				if (num == 1) {
					$(".nothing").removeClass("hd");
				} 
				$(window).unbind("scroll", defaultScrollHandler);
			}else{
				$(".nothing").addClass("hd");
				$(diplayID).append(data);
				initPage();// 表情解析
				prizeBindEvent();
			}
		}
	});
}

/**
 * 重写更新赞的数量
 * 
 * @param obj
 * @param isprize
 */
function updatePrizeCount(obj, isprize){
	var countstr = $(obj).find(".zancountjs").html();
	if (isprize) {
		$(obj).find(".zancountjs").html(parseInt(countstr)+1);
	} else {
		$(obj).find(".zancountjs").html(parseInt(countstr)-1);
	}
}

/**
 * 重写解除事件绑定
 */
function unRegisterPraise(){
	$("a[id^='btnprize']").each(function(){
		$(this).off("click");
	});
}

/**
 * 获得输入框焦点
 * 
 * @returns
 */
function wantComment() {
	$("#content").focus();
}



var firstuid;
var pagenum;
function showcomment(obj){
	var display=$(obj).data("reply");
	if(display == "true"){
		$(obj).parent().parent().siblings("#second").addClass("hd");
		$(obj).parent().parent().siblings("#second").empty();
		$(obj).data("reply","false");
		$(obj).children("img").attr('src', baseimg +'/imgs/default/arrawDown.png'); 
		return;
	} else{
		$(obj).data("reply","true");
		$(obj).parent().parent().siblings("#second").removeClass("hd");
		firstuid = $(obj).parent().parent().data("uid");
		pagenum=1;
		getcomment(obj);
		$("#loadmore").bind("click", function(){
			getcomment(obj);
		});
		$(obj).children("img").attr('src', baseimg +'/imgs/default/arrawDownup.png'); 
	}
}

function load(obj){
	var moreobj = $(obj).parent().siblings(".commentRt").children(".operate").children(".leftcomments");
	getcomment(moreobj);
}
function getcomment(obj){
	var url = base + "/ajax/comment/secondComment_"+firstuid+"_"+cid+"_{0}".format(pagenum);
	$.ajax({
		type:"GET",
		url:url,
		success:function(data){
			if(data.trim() == ""){
				$(".loadmorefinance").addClass("hd");
			}else{
				if($(obj).parent().parent().siblings("#second").children(".ment").length>19){
					$(".loadmorefinance").removeClass("hd");
				}
				$(obj).parent().parent().siblings("#second").append(data);
				initPage();
				$(obj).parent().parent().siblings("#second").css("display","block");
				pagenum+=1;
				prizeBindEvent();
			}
		}
	});
}

function deleteComment(obj){
	var topuid = $(obj).data("topuid");
	var articlecommentcount = $("#articlecommentcount").html();
	if(topuid != null && topuid != '' && topuid != 'undefined'){
		var secondcommentcount = $(obj).parent().parent().siblings(".commentRt").children(".operate").children(".leftcomments").children("#commentcount").html();
	}else{
		var secondcommentcount = $(obj).children(".operate").children(".leftcomments").children("#commentcount").html();
	}
	var commentuid = $(obj).data("uid");
	var useruid = $(obj).data("touseruid");
	var url = base + "/ajax/comments/delete/"+commentuid+"/"+useruid;
	$.ajax({
		type:"GET",
		url:url,
		success:function(data){
			if(data){
				if(topuid != null && topuid != '' && topuid != 'undefined'){
					$(obj).parent().parent().siblings(".replay_comment").children(".operate").children(".leftcomments").children("#commentcount").html(parseInt(secondcommentcount) - 1);
					var tempcount = $(obj).parent().parent().siblings(".replay_comment").children(".operate").children(".leftcomments").children("#commentcount").html();
					$("#articlecommentcount").html(parseInt(articlecommentcount) - 1);
					if(tempcount == 0){
						$(obj).parent().parent().siblings(".replay_comment").children(".operate").children(".leftcomments").addClass("hd");
					}
				}else{
					$("#articlecommentcount").html(parseInt(articlecommentcount) - parseInt(secondcommentcount) -1);
				}
				$(obj).parent().addClass("hd");
			}else{
				return;
			}
		}
	});
}

/*******************************************************************************
 * 表情
 */
// 将[em_*]替换为img标签
function replaceContent(str) {
	str = str.replace(/\[em_([0-9]*)\]/g,'<img src="' + g.baseimg + '/imgs/face/qq/$1.gif" border="0" />');
	return str;
}

var idNumber = 0;
function getIdNumber() {
	idNumber++;
	return "finance_" + idNumber.toString();
}

function initBindEvent() {
	$('.face').unbind( "click" );
	$('.face').qqFace({ 
        assign:'content', 
        path: g.baseimg + '/imgs/face/qq/'
    });
}

/* 生成页面表情 */
function initPage() {
	$(".comment").each(function(){
		var content = replaceContent($(this).html());
		$(this).html(content);
	});
}

/* 返回要赋值的输入框 */
function initData(obj) {
	var assign=$(obj).parent().parent().parent().find("textarea").data("suffix");
	return assign;        
}
