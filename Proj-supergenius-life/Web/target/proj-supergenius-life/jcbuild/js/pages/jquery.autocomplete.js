(function(b){b.fn.extend({autocomplete:function(a,c){var r="string"==typeof a;c=b.extend({},b.Autocompleter.defaults,{url:r?a:null,data:r?null:a,delay:r?b.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(a){return a};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new b.Autocompleter(this,c)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});b.Autocompleter=function(a,c){function r(){var v=l.selected();if(!v)return!1;var d=v.result;m=d;if(c.multiple){var e=q(f.val());if(1<e.length){var h=c.multipleSeparator.length,j=b(a).selection().start,k,g=0;b.each(e,function(a,c){g+=c.length;if(j<=g)return k=a,!1;g+=h});e[k]=d;d=e.join(c.multipleSeparator)}d+=c.multipleSeparator}f.val(d);p();f.trigger("result",[v.data,v.value]);
return!0}function n(a,b){if(w==h.DEL)l.hide();else{var j=f.val();if(b||j!=m)m=j,j=g(j),j.length>=c.minChars?(f.addClass(c.loadingClass),c.matchCase||(j=j.toLowerCase()),e(j,d,p)):(f.removeClass(c.loadingClass),l.hide())}}function q(a){return!a?[""]:!c.multiple?[b.trim(a)]:b.map(a.split(c.multipleSeparator),function(c){return b.trim(a).length?b.trim(c):null})}function g(d){if(!c.multiple)return d;var j=q(d);if(1==j.length)return j[0];j=b(a).selection().start;j=j==d.length?q(d):q(d.replace(d.substring(j),
""));return j[j.length-1]}function p(){l.visible();l.hide();clearTimeout(s);f.removeClass(c.loadingClass);c.mustMatch&&f.search(function(a){a||(c.multiple?(a=q(f.val()).slice(0,-1),f.val(a.join(c.multipleSeparator)+(a.length?c.multipleSeparator:""))):(f.val(""),f.trigger("result",null)))})}function d(d,e){if(e&&e.length&&j){f.removeClass(c.loadingClass);l.display(e,d);var k=e[0].value;c.autoFill&&(g(f.val()).toLowerCase()==d.toLowerCase()&&w!=h.BACKSPACE)&&(f.val(f.val()+k.substring(g(m).length)),
b(a).selection(m.length,m.length+k.length));l.show()}else p()}function e(d,j,e){c.matchCase||(d=d.toLowerCase());var h=k.load(d);if(h&&h.length)j(d,h);else if("string"==typeof c.url&&0<c.url.length){var f={timestamp:+new Date};b.each(c.extraParams,function(a,d){f[a]="function"==typeof d?d():d});b.ajax({mode:"abort",port:"autocomplete"+a.name,dataType:c.dataType,url:c.url,data:b.extend({q:g(d),limit:c.max},f),success:function(a){var e;if(!(e=c.parse&&c.parse(a))){e=[];a=a.split("\n");for(var h=0;h<
a.length;h++){var f=b.trim(a[h]);f&&(f=f.split("|"),e[e.length]={data:f,value:f[0],result:c.formatResult&&c.formatResult(f,f[0])||f[0]})}}k.add(d,e);j(d,e)}})}else l.emptyList(),e(d)}var h={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},f=b(a).attr("autocomplete","off").addClass(c.inputClass),s,m="",k=b.Autocompleter.Cache(c),j=0,w,u={mouseDownOnSelect:!1},l=b.Autocompleter.Select(c,a,r,u),t;b.browser.opera&&b(a.form).bind("submit.autocomplete",function(){if(t)return t=
!1});f.bind((b.browser.opera?"keypress":"keydown")+".autocomplete",function(a){j=1;w=a.keyCode;switch(a.keyCode){case h.UP:a.preventDefault();l.visible()?l.prev():n(0,!0);break;case h.DOWN:a.preventDefault();l.visible()?l.next():n(0,!0);break;case h.PAGEUP:a.preventDefault();l.visible()?l.pageUp():n(0,!0);break;case h.PAGEDOWN:a.preventDefault();l.visible()?l.pageDown():n(0,!0);break;case c.multiple&&","==b.trim(c.multipleSeparator)&&h.COMMA:case h.TAB:case h.RETURN:if(r())return a.preventDefault(),
t=!0,!1;break;case h.ESC:l.hide();break;default:clearTimeout(s),s=setTimeout(n,c.delay)}}).focus(function(){j++}).blur(function(){j=0;u.mouseDownOnSelect||(clearTimeout(s),s=setTimeout(p,200))}).click(function(){1<j++&&!l.visible()&&n(0,!0)}).bind("search",function(){function a(c,e){var j;if(e&&e.length)for(var b=0;b<e.length;b++)if(e[b].result.toLowerCase()==c.toLowerCase()){j=e[b];break}"function"==typeof d?d(j):f.trigger("result",j&&[j.data,j.value])}var d=1<arguments.length?arguments[1]:null;
b.each(q(f.val()),function(d,c){e(c,a,a)})}).bind("flushCache",function(){k.flush()}).bind("setOptions",function(a,d){b.extend(c,d);"data"in d&&k.populate()}).bind("unautocomplete",function(){l.unbind();f.unbind();b(a.form).unbind(".autocomplete")})};b.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},
formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,c){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};b.Autocompleter.Cache=function(a){function c(d,c){a.matchCase||(d=d.toLowerCase());var b=d.indexOf(c);"word"==a.matchContains&&(b=d.toLowerCase().search("\\b"+c.toLowerCase()));return-1==b?!1:0==b||a.matchContains}function r(d,
c){p>a.cacheLength&&q();g[d]||p++;g[d]=c}function n(){if(!a.data)return!1;var d={},c=0;a.url||(a.cacheLength=1);d[""]=[];for(var h=0,f=a.data.length;h<f;h++){var g=a.data[h],g="string"==typeof g?[g]:g,m=a.formatMatch(g,h+1,a.data.length);if(!1!==m){var k=m.charAt(0).toLowerCase();d[k]||(d[k]=[]);g={value:m,data:g,result:a.formatResult&&a.formatResult(g)||m};d[k].push(g);c++<a.max&&d[""].push(g)}}b.each(d,function(d,c){a.cacheLength++;r(d,c)})}function q(){g={};p=0}var g={},p=0;setTimeout(n,25);return{flush:q,
add:r,populate:n,load:function(d){if(!a.cacheLength||!p)return null;if(!a.url&&a.matchContains){var e=[],h;for(h in g)if(0<h.length){var f=g[h];b.each(f,function(a,b){c(b.value,d)&&e.push(b)})}return e}if(g[d])return g[d];if(a.matchSubset)for(h=d.length-1;h>=a.minChars;h--)if(f=g[d.substr(0,h)])return e=[],b.each(f,function(a,b){c(b.value,d)&&(e[e.length]=b)}),e;return null}}};b.Autocompleter.Select=function(a,c,r,n){function q(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return!a?[]:a}function g(c){d.slice(e,
e+1).removeClass(p.ACTIVE);e+=c;0>e?e=d.size()-1:e>=d.size()&&(e=0);c=d.slice(e,e+1).addClass(p.ACTIVE);if(a.scroll){var b=0;d.slice(0,e).each(function(){b+=this.offsetHeight});b+c[0].offsetHeight-k.scrollTop()>k[0].clientHeight?k.scrollTop(b+c[0].offsetHeight-k.innerHeight()):b<k.scrollTop()&&k.scrollTop(b)}}var p={ACTIVE:"ac_over"},d,e=-1,h,f="",s=!0,m,k;return{display:function(j,g){s&&(m=b("<div/>").hide().addClass(a.resultsClass).css("position","absolute").appendTo(document.body),k=b("<ul/>").appendTo(m).mouseover(function(a){q(a).nodeName&&
"LI"==q(a).nodeName.toUpperCase()&&(e=b("li",k).removeClass(p.ACTIVE).index(q(a)),b(q(a)).addClass(p.ACTIVE))}).click(function(a){b(q(a)).addClass(p.ACTIVE);r();c.focus();return!1}).mousedown(function(){n.mouseDownOnSelect=!0}).mouseup(function(){n.mouseDownOnSelect=!1}),0<a.width&&m.css("width",a.width),s=!1);h=j;f=g;k.empty();for(var u=a.max&&a.max<h.length?a.max:h.length,l=0;l<u;l++)if(h[l]){var t=a.formatItem(h[l].data,l+1,u,h[l].value,f);!1!==t&&(t=b("<li/>").html(a.highlight(t,f)).addClass(0==
l%2?"ac_even":"ac_odd").appendTo(k)[0],b.data(t,"ac_data",h[l]))}d=k.find("li");a.selectFirst&&(d.slice(0,1).addClass(p.ACTIVE),e=0);b.fn.bgiframe&&k.bgiframe()},next:function(){g(1)},prev:function(){g(-1)},pageUp:function(){0!=e&&0>e-8?g(-e):g(-8)},pageDown:function(){e!=d.size()-1&&e+8>d.size()?g(d.size()-1-e):g(8)},hide:function(){m&&m.hide();d&&d.removeClass(p.ACTIVE);e=-1},visible:function(){return m&&m.is(":visible")},current:function(){return this.visible()&&(d.filter("."+p.ACTIVE)[0]||a.selectFirst&&
d[0])},show:function(){var e=b(c).offset();m.css({width:"string"==typeof a.width||0<a.width?a.width:b(c).width(),top:e.top+c.offsetHeight,left:e.left}).show();if(a.scroll&&(k.scrollTop(0),k.css({maxHeight:a.scrollHeight,overflow:"auto"}),b.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var f=0;d.each(function(){f+=this.offsetHeight});e=f>a.scrollHeight;k.css("height",e?a.scrollHeight:f);e||d.width(k.width()-parseInt(d.css("padding-left"))-parseInt(d.css("padding-right")))}},selected:function(){var a=
d&&d.filter("."+p.ACTIVE).removeClass(p.ACTIVE);return a&&a.length&&b.data(a[0],"ac_data")},emptyList:function(){k&&k.empty()},unbind:function(){m&&m.remove()}}};b.fn.selection=function(a,c){if(void 0!==a)return this.each(function(){if(this.createTextRange){var b=this.createTextRange();void 0===c||a==c?b.move("character",a):(b.collapse(!0),b.moveStart("character",a),b.moveEnd("character",c));b.select()}else this.setSelectionRange?this.setSelectionRange(a,c):this.selectionStart&&(this.selectionStart=
a,this.selectionEnd=c)});var b=this[0];if(b.createTextRange){var n=document.selection.createRange(),q=b.value,g=n.text.length;n.text="<->";n=b.value.indexOf("<->");b.value=q;this.selection(n,n+g);return{start:n,end:n+g}}if(void 0!==b.selectionStart)return{start:b.selectionStart,end:b.selectionEnd}}})(jQuery);
